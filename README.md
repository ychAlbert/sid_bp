# ç»Ÿä¸€åŒ–BP-Freeç®—æ³•æ¯”è¾ƒæ¡†æ¶

æœ¬é¡¹ç›®æ—¨åœ¨æä¾›ä¸€ä¸ªç»Ÿä¸€ã€æ¨¡å—åŒ–çš„æ¡†æ¶ï¼Œç”¨äºè®­ç»ƒå’Œæ¯”è¾ƒå¤šç§åå‘ä¼ æ’­-æ— å…³ï¼ˆBackpropagation-Freeï¼‰çš„æ·±åº¦å­¦ä¹ ç®—æ³•ã€‚é€šè¿‡å°†å¤šä¸ªç‹¬ç«‹çš„ç®—æ³•ä»“åº“æ•´åˆåˆ°ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£å’Œå·¥ä½œæµä¸‹ï¼Œç ”ç©¶äººå‘˜å¯ä»¥æ›´ä¾¿æ·åœ°è¿›è¡Œå…¬å¹³çš„å®éªŒå¯¹æ¯”ã€å…±äº«æ•°æ®é›†å’Œç®¡ç†å®éªŒç»“æœã€‚

ç›®å‰é›†æˆçš„ç®—æ³•åŒ…æ‹¬ï¼š
- **SID (æœ¬æ–‡æ–¹æ³•)** å’Œ **Baseline (åŸºçº¿)**
- [**Synthetic Gradients (SG)**](https://arxiv.org/abs/1608.05343)
- [**The Forward-Forward Algorithm (FF)**](https://www.cs.toronto.edu/~hinton/FFA13.pdf)
- [**Equilibrium Propagation (EP)**](https://arxiv.org/abs/2006.03824)

## âœ¨ ä¸»è¦ç‰¹æ€§

- **ç»Ÿä¸€çš„è®­ç»ƒå…¥å£**: ä½¿ç”¨å•ä¸ª `main.py` è„šæœ¬å³å¯å¯åŠ¨ä»»ä½•å·²é›†æˆçš„ç®—æ³•ã€‚
- **å…±äº«çš„æ•°æ®ä¸ç»“æœç›®å½•**: æ‰€æœ‰ç®—æ³•å…±ç”¨ `./data` ç›®å½•ä¸‹çš„æ•°æ®é›†ï¼Œå¹¶å°†å®éªŒç»“æœç»Ÿä¸€è¾“å‡ºåˆ° `./result` ç›®å½•ï¼Œä¾¿äºç®¡ç†å’Œåˆ†æã€‚
- **æ¨¡å—åŒ–ç®—æ³•è®¾è®¡**: æ¯ä¸ªç®—æ³•éƒ½è¢«å°è£…åœ¨ä¸€ä¸ªç‹¬ç«‹çš„"åŒ…è£…å™¨"ï¼ˆwrapperï¼‰ä¸­ï¼Œä½¿å…¶ä¸ä¸»æ¡†æ¶è§£è€¦ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚
- **çµæ´»çš„å‚æ•°é…ç½®**: æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œä¼ é€’é€šç”¨å‚æ•°ï¼ˆå¦‚ `epochs`, `batch_size`ï¼‰å’Œç‰¹å®šäºç®—æ³•çš„å¤æ‚è¶…å‚æ•°ï¼ˆé€šè¿‡JSONå­—ç¬¦ä¸²ï¼‰ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ main.py                 # ç»Ÿä¸€çš„å®éªŒå¯åŠ¨å…¥å£
â”œâ”€â”€ sid.py                  # SIDç®—æ³•å’ŒåŸºçº¿æ–¹æ³•çš„å®ç°
â”œâ”€â”€ README.md               # æœ¬æ–‡æ¡£
â”œâ”€â”€ requirements.txt        # é¡¹ç›®ä¾èµ–
â”‚
â”œâ”€â”€ data/                     # å…±äº«çš„æ•°æ®é›†ç›®å½• (è‡ªåŠ¨åˆ›å»ºå’Œä¸‹è½½)
â”‚   â”œâ”€â”€ mnist/
â”‚   â””â”€â”€ cifar10/
â”‚
â”œâ”€â”€ result/                   # å…±äº«çš„å®éªŒç»“æœç›®å½• (è‡ªåŠ¨åˆ›å»º)
â”‚   â”œâ”€â”€ sid/
â”‚   â”œâ”€â”€ baseline/
â”‚   â”œâ”€â”€ synthetic_gradient/
â”‚   â”œâ”€â”€ forward_forward/
â”‚   â””â”€â”€ equilibrium_propagation/
â”‚
â””â”€â”€ algorithms/               # å­˜æ”¾æ‰€æœ‰ç§»æ¤çš„ç¬¬ä¸‰æ–¹ç®—æ³•
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ sg_wrapper.py         # SG çš„åŒ…è£…å™¨
    â”œâ”€â”€ ff_wrapper.py         # FF çš„åŒ…è£…å™¨
    â”œâ”€â”€ ep_wrapper.py         # EP çš„åŒ…è£…å™¨
    â”‚
    â”œâ”€â”€ synthetic_gradient/   # SG çš„å®Œæ•´æºä»£ç 
    â”œâ”€â”€ forward_forward/      # FF çš„å®Œæ•´æºä»£ç 
    â””â”€â”€ equilibrium_propagation/ # EP çš„å®Œæ•´æºä»£ç 
```

## ğŸš€ å®‰è£…ä¸ç¯å¢ƒè®¾ç½®

1.  **å…‹éš†ä»“åº“**
    ```bash
    git clone <your-repository-url>
    cd <your-repository-name>
    ```

2.  **åˆ›å»ºå¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ** (æ¨è)
    ```bash
    # ä½¿ç”¨ conda
    conda create -n bp_free python=3.8
    conda activate bp_free

    # æˆ–è€…ä½¿ç”¨ venv
    python -m venv venv
    source venv/bin/activate  # åœ¨ Linux/macOS ä¸Š
    .\venv\Scripts\activate   # åœ¨ Windows ä¸Š
    ```

3.  **å®‰è£…ä¾èµ–**
    é¦–å…ˆï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `requirements.txt` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
    ```
    torch
    torchvision
    matplotlib
    hydra-core
    omegaconf
    ```
    ç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…ï¼š
    ```bash
    pip install -r requirements.txt
    ```

4.  **å‡†å¤‡æ•°æ®é›†**
    æ— éœ€æ‰‹åŠ¨ä¸‹è½½ã€‚é¦–æ¬¡è¿è¡Œé’ˆå¯¹ç‰¹å®šæ•°æ®é›†ï¼ˆå¦‚CIFAR-10ï¼‰çš„è®­ç»ƒæ—¶ï¼Œä»£ç ä¼šè‡ªåŠ¨ä»`torchvision`ä¸‹è½½å¹¶ä¿å­˜åˆ° `./data` ç›®å½•ã€‚

## ğŸ’¡ ä½¿ç”¨æ–¹æ³•

æ‰€æœ‰å®éªŒéƒ½é€šè¿‡ `main.py` å¯åŠ¨ã€‚æ ¸å¿ƒæ˜¯ `--algorithm` å‚æ•°ï¼Œå®ƒå†³å®šäº†è¦è¿è¡Œå“ªä¸ªç®—æ³•ã€‚

### åŸºæœ¬æ‰§è¡Œ

```bash
python main.py --algorithm <algorithm_name> [COMMON_OPTIONS]
```

**é€šç”¨é€‰é¡¹ (COMMON_OPTIONS):**

- `--algorithm`: **(å¿…éœ€)** æŒ‡å®šè¦è¿è¡Œçš„ç®—æ³•ã€‚å¯é€‰å€¼: `sid`, `baseline`, `synthetic_gradient`, `forward_forward`, `equilibrium_propagation`ã€‚
- `--dataset`: ä½¿ç”¨çš„æ•°æ®é›†ã€‚é»˜è®¤ä¸º `cifar10`ã€‚å¯é€‰: `mnist`, `cifar10`ã€‚
- `--epochs`: è®­ç»ƒè½®æ•°ã€‚é»˜è®¤ä¸º `100`ã€‚
- `--batch_size`: æ‰¹å¤„ç†å¤§å°ã€‚é»˜è®¤ä¸º `128`ã€‚
- `--learning_rate`: å­¦ä¹ ç‡ (æ³¨æ„: å¯¹äºæŸäº›ç®—æ³•å¦‚EPï¼Œæ­¤å‚æ•°å¯èƒ½è¢«å…¶æ›´å¤æ‚çš„å­¦ä¹ ç‡ç­–ç•¥è¦†ç›–)ã€‚é»˜è®¤ä¸º `0.01`ã€‚
- `--device`: è¿è¡Œè®¾å¤‡ã€‚é»˜è®¤ä¸º `cuda` (å¦‚æœå¯ç”¨)ï¼Œå¦åˆ™ä¸º `cpu`ã€‚

### æŒ‡å®šç®—æ³•ç‰¹å®šå‚æ•°

æ¯ä¸ªç®—æ³•éƒ½æœ‰å…¶ç‹¬ç‰¹çš„è¶…å‚æ•°ã€‚ä½¿ç”¨ `--alg_args` å‚æ•°ï¼Œé€šè¿‡ä¸€ä¸ªJSONæ ¼å¼çš„å­—ç¬¦ä¸²æ¥ä¼ é€’å®ƒä»¬ã€‚

**é‡è¦æç¤º**: åœ¨å‘½ä»¤è¡Œä¸­ä¼ é€’JSONå­—ç¬¦ä¸²æ—¶ï¼Œè¯·æ³¨æ„å¼•å·çš„ä½¿ç”¨ï¼
-   åœ¨ **Linux, macOS, æˆ– Git Bash** ä¸­ï¼Œç”¨å•å¼•å· `'` åŒ…å›´æ•´ä¸ªJSONå­—ç¬¦ä¸²ï¼š
    ```bash
    --alg_args '{"key": "value", "number": 123}'
    ```
-   åœ¨ **Windows å‘½ä»¤æç¤ºç¬¦ (cmd.exe)** ä¸­ï¼Œç”¨åŒå¼•å· `"` åŒ…å›´æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ç”¨åæ–œæ  `\` è½¬ä¹‰å†…éƒ¨çš„åŒå¼•å·ï¼š
    ```cmd
    --alg_args "{\"key\": \"value\", \"number\": 123}"
    ```

---

## ğŸ”¬ ç®—æ³•è¿è¡Œç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸ºæ¯ä¸ªç®—æ³•æä¾›çš„å…·ä½“è¿è¡Œå‘½ä»¤ç¤ºä¾‹ã€‚

### 1. SID å’Œ Baseline

*(è¯·æ ¹æ®ä½ çš„ `sid.py` å®ç°æ¥è¡¥å……æ­¤å¤„çš„å‚æ•°å’Œç¤ºä¾‹)*

```bash
# è¿è¡Œä½ çš„SIDç®—æ³•
python main.py --algorithm sid --dataset cifar10 --epochs 150

# è¿è¡ŒåŸºçº¿æ–¹æ³•
python main.py --algorithm baseline --dataset cifar10 --epochs 150
```

### 2. Synthetic Gradients (SG)

**ä¸»è¦å¯é…ç½®å‚æ•° (`--alg_args`):**
- `model_type` (str): æ¨¡å‹ç±»å‹ï¼Œ`cnn` æˆ– `mlp`ã€‚é»˜è®¤ä¸º `cnn`ã€‚
- `conditioned` (bool): æ˜¯å¦ä½¿ç”¨æ¡ä»¶DNIã€‚é»˜è®¤ä¸º `false`ã€‚

**ç¤ºä¾‹:**
```bash
# åœ¨CIFAR-10ä¸Šè¿è¡ŒCNNæ¨¡å‹ (é»˜è®¤é…ç½®)
python main.py --algorithm synthetic_gradient --dataset cifar10 --epochs 300 --batch_size 100

# åœ¨MNISTä¸Šè¿è¡Œä¸€ä¸ªæ¡ä»¶MLPæ¨¡å‹
python main.py --algorithm synthetic_gradient --dataset mnist --epochs 100 \
--alg_args '{"model_type": "mlp", "conditioned": true}'
```

### 3. Forward-Forward (FF)

**ä¸»è¦å¯é…ç½®å‚æ•° (`--alg_args`):**
- `model` (dict):
    - `hidden_dim` (int): éšè—å±‚ç»´åº¦ã€‚é»˜è®¤ `1000`ã€‚
    - `num_layers` (int): å±‚æ•°ã€‚é»˜è®¤ `3`ã€‚
- `training` (dict):
    - `downstream_learning_rate` (float): åˆ†ç±»å¤´å­¦ä¹ ç‡ã€‚é»˜è®¤ `1e-2`ã€‚

**ç¤ºä¾‹:**
```bash
# ä½¿ç”¨é»˜è®¤å‚æ•°åœ¨CIFAR-10ä¸Šè¿è¡Œ
python main.py --algorithm forward_forward --dataset cifar10 --epochs 100 --batch_size 100

# è‡ªå®šä¹‰æ¨¡å‹å±‚æ•°å’Œéšè—ç»´åº¦
python main.py --algorithm forward_forward --dataset cifar10 --epochs 100 \
--alg_args '{"model": {"num_layers": 4, "hidden_dim": 2048}}'
```

### 4. Equilibrium Propagation (EP)

EPçš„å‚æ•°éå¸¸å¤šï¼ŒåŒ…è£…å™¨ä¸­å·²è®¾ç½®äº†è®ºæ–‡ä¸­çš„æ¨èé»˜è®¤å€¼ã€‚

**ä¸»è¦å¯é…ç½®å‚æ•° (`--alg_args`):**
- `lrs` (list): é€å±‚çš„å­¦ä¹ ç‡ã€‚
- `betas` (list): EPçš„betaå‚æ•° `[beta_1, beta_2]`ã€‚é»˜è®¤ `[0.0, 0.5]`ã€‚
- `T1`, `T2` (int): è‡ªç”±é˜¶æ®µå’Œå¾®æ‰°é˜¶æ®µçš„è¿­ä»£æ­¥æ•°ã€‚é»˜è®¤ `T1=250`, `T2=30`ã€‚
- `loss` (str): æŸå¤±å‡½æ•°, `mse` æˆ– `cel`ã€‚é»˜è®¤ `mse`ã€‚

**ç¤ºä¾‹:**
```bash
# ä½¿ç”¨CIFAR-10çš„æ¨èé»˜è®¤å€¼è¿è¡Œ
python main.py --algorithm equilibrium_propagation --dataset cifar10 --epochs 120 --batch_size 128

# ä¿®æ”¹betaå€¼å’ŒæŸå¤±å‡½æ•°ä¸ºCrossEntropy
python main.py --algorithm equilibrium_propagation --dataset cifar10 --epochs 120 \
--alg_args '{"betas": [0.0, 1.0], "loss": "cel", "softmax": true}'
```

## ğŸ“Š æŸ¥çœ‹ç»“æœ

æ‰€æœ‰å®éªŒçš„è¾“å‡ºï¼ŒåŒ…æ‹¬æ—¥å¿—æ–‡ä»¶ã€æ¨¡å‹æƒé‡ (`.pkl` æˆ– `.pt`) å’Œæ€§èƒ½å›¾è¡¨ï¼Œéƒ½å°†ä¿å­˜åœ¨ `result/` ç›®å½•ä¸‹ï¼Œå¹¶æŒ‰ç®—æ³•åç§°åˆ†å­æ–‡ä»¶å¤¹å­˜æ”¾ã€‚

## ğŸ§© å¦‚ä½•æ·»åŠ æ–°ç®—æ³•

æœ¬æ¡†æ¶çš„æ¨¡å—åŒ–è®¾è®¡ä½¿å¾—æ·»åŠ æ–°çš„BP-Freeç®—æ³•å˜å¾—ç®€å•ï¼š

1.  **å¤åˆ¶ä»£ç **: å°†æ–°ç®—æ³•çš„å®Œæ•´æºä»£ç æ–‡ä»¶å¤¹æ”¾å…¥ `algorithms/` ç›®å½•ä¸‹ã€‚
2.  **åˆ›å»º`__init__.py`**: åœ¨æ–°ç®—æ³•çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªç©ºçš„ `__init__.py` æ–‡ä»¶ï¼Œä»¥å°†å…¶æ ‡è®°ä¸ºPythonåŒ…ã€‚
3.  **ç¼–å†™åŒ…è£…å™¨**: åœ¨ `algorithms/` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ `new_alg_wrapper.py` æ–‡ä»¶ã€‚
4.  **å®ç°`run`å‡½æ•°**: åœ¨åŒ…è£…å™¨ä¸­ï¼Œå®ç°ä¸€ä¸ªåä¸º `run(config)` çš„å‡½æ•°ã€‚æ­¤å‡½æ•°è´Ÿè´£ï¼š
    -   æ¥æ”¶ç»Ÿä¸€çš„ `config` å­—å…¸ã€‚
    -   å°† `config` ç¿»è¯‘æˆæ–°ç®—æ³•æ‰€éœ€çš„å‚æ•°æ ¼å¼ï¼ˆå¦‚ `argparse.Namespace`ï¼‰ã€‚
    -   ç¡®ä¿ç®—æ³•ä» `config['data_path']` åŠ è½½æ•°æ®ã€‚
    -   ç¡®ä¿ç®—æ³•å°†ç»“æœä¿å­˜åˆ° `config['result_path']`ã€‚
    -   è°ƒç”¨æ–°ç®—æ³•çš„æ ¸å¿ƒè®­ç»ƒé€»è¾‘ã€‚
5.  **æ•´åˆåˆ°ä¸»å…¥å£**: åœ¨ `main.py` ä¸­ï¼Œå¯¼å…¥ä½ çš„æ–°åŒ…è£…å™¨ï¼Œå¹¶åœ¨ä¸»é€»è¾‘ä¸­æ·»åŠ ä¸€ä¸ª `elif` åˆ†æ”¯æ¥è°ƒç”¨å®ƒçš„ `run` å‡½æ•°ã€‚

